# =============================================================================
# ğŸ› ï¸  SOLVIEW DEMO APP - MAKEFILE
# =============================================================================
# AutomaÃ§Ã£o para desenvolvimento, build, teste e deploy
# =============================================================================

.PHONY: help install dev test lint format build run clean docker-build docker-run docker-stop docker-clean

# ğŸ“‹ Help
help: ## Mostrar ajuda
	@echo "ğŸŒŸ Solview Demo App - Comandos DisponÃ­veis:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

# ğŸ—ï¸  Development
install: ## Instalar dependÃªncias
	@echo "ğŸ“¦ Instalando dependÃªncias..."
	poetry install
	pre-commit install

dev: ## Executar em modo desenvolvimento
	@echo "ğŸš€ Iniciando aplicaÃ§Ã£o em modo desenvolvimento..."
	poetry run uvicorn app.server:app --host 0.0.0.0 --port 8000 --reload

dev-with-logs: ## Executar com logs estruturados
	@echo "ğŸš€ Iniciando aplicaÃ§Ã£o com logs estruturados..."
	SOLVIEW_LOG_LEVEL=DEBUG poetry run uvicorn app.server:app --host 0.0.0.0 --port 8000 --reload

# ğŸ§ª Testing
test: ## Executar todos os testes
	@echo "ğŸ§ª Executando testes..."
	poetry run pytest src/tests/ -v

test-unit: ## Executar testes unitÃ¡rios
	@echo "ğŸ§ª Executando testes unitÃ¡rios..."
	poetry run pytest src/tests/unit/ -v

test-integration: ## Executar testes de integraÃ§Ã£o
	@echo "ğŸ§ª Executando testes de integraÃ§Ã£o..."
	poetry run pytest src/tests/integration/ -v

test-coverage: ## Executar testes com coverage
	@echo "ğŸ§ª Executando testes com coverage..."
	poetry run pytest --cov=src/app --cov-report=html --cov-report=term-missing

# ğŸ” Code Quality
lint: ## Executar linting
	@echo "ğŸ” Executando linting..."
	poetry run flake8 src/
	poetry run mypy src/app/

format: ## Formatar cÃ³digo
	@echo "âœ¨ Formatando cÃ³digo..."
	poetry run black src/
	poetry run isort src/

format-check: ## Verificar formataÃ§Ã£o
	@echo "âœ¨ Verificando formataÃ§Ã£o..."
	poetry run black --check src/
	poetry run isort --check-only src/

# ğŸ—ï¸  Build
build: ## Build da aplicaÃ§Ã£o
	@echo "ğŸ—ï¸  Fazendo build da aplicaÃ§Ã£o..."
	poetry build

# ğŸ³ Docker
docker-build: ## Build da imagem Docker
	@echo "ğŸ³ Construindo imagem Docker..."
	docker build -t solview-demo-app:latest .

docker-run: ## Executar container Docker
	@echo "ğŸ³ Executando container Docker..."
	docker run -d \
		--name solview-demo-app \
		-p 8000:8000 \
		-e SOLVIEW_ENVIRONMENT=docker \
		solview-demo-app:latest

docker-stop: ## Parar container Docker
	@echo "ğŸ³ Parando container Docker..."
	docker stop solview-demo-app || true
	docker rm solview-demo-app || true

docker-clean: ## Limpar imagens Docker
	@echo "ğŸ³ Limpando imagens Docker..."
	docker rmi solview-demo-app:latest || true

# ğŸ§¹ Cleanup
clean: ## Limpar arquivos temporÃ¡rios
	@echo "ğŸ§¹ Limpando arquivos temporÃ¡rios..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .coverage htmlcov/ .pytest_cache/ .mypy_cache/

# ğŸš€ Production
production-check: ## Verificar se estÃ¡ pronto para produÃ§Ã£o
	@echo "ğŸš€ Verificando se estÃ¡ pronto para produÃ§Ã£o..."
	$(MAKE) format-check
	$(MAKE) lint
	$(MAKE) test
	@echo "âœ… AplicaÃ§Ã£o pronta para produÃ§Ã£o!"

# ğŸ“Š Observability
metrics-check: ## Verificar mÃ©tricas
	@echo "ğŸ“Š Verificando endpoint de mÃ©tricas..."
	curl -f http://localhost:8000/metrics || echo "âŒ MÃ©tricas nÃ£o disponÃ­veis"

health-check: ## Verificar health da aplicaÃ§Ã£o
	@echo "â¤ï¸  Verificando health da aplicaÃ§Ã£o..."
	curl -f http://localhost:8000/health || echo "âŒ Health check falhou"

traces-test: ## Gerar traces para teste
	@echo "ğŸ” Gerando traces para teste..."
	for i in {1..10}; do \
		curl -s http://localhost:8000/api/catalog/products > /dev/null; \
		curl -s http://localhost:8000/api/cart/create > /dev/null; \
		sleep 1; \
	done
	@echo "âœ… Traces gerados!"

# ğŸ”§ Development Utils
requirements: ## Gerar requirements.txt
	@echo "ğŸ“‹ Gerando requirements.txt..."
	poetry export -f requirements.txt --output requirements.txt --without-hashes

tree: ## Mostrar estrutura do projeto
	@echo "ğŸŒ³ Estrutura do projeto:"
	tree -I '__pycache__|*.pyc|.git|.pytest_cache|.mypy_cache|htmlcov' --dirsfirst

# ğŸ“ˆ Load Testing
load-test: ## Executar teste de carga simples
	@echo "ğŸ“ˆ Executando teste de carga..."
	@for i in {1..100}; do \
		curl -s http://localhost:8000/api/catalog/products > /dev/null & \
	done; \
	wait
	@echo "âœ… Teste de carga concluÃ­do!"

# ğŸ”„ Development Workflow
dev-setup: install format test ## Setup completo para desenvolvimento
	@echo "âœ… Setup de desenvolvimento concluÃ­do!"

ci-check: format-check lint test ## VerificaÃ§Ã£o para CI/CD
	@echo "âœ… VerificaÃ§Ã£o de CI/CD concluÃ­da!"

# Default target
.DEFAULT_GOAL := help
